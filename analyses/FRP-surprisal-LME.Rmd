---
title: "FRP surpisal"
author: "Rosy Southwell"
date: "2024-07-25"
output: 
  html_document:
    toc: true
    toc_depth: 3
---
#
```{r,message=FALSE, warning=FALSE, echo=F, include=F}
library(lme4)
library(lmerTest)
library(reshape2)
library(plyr)
library(beepr)
library(car)
library(sjPlot)
library(emmeans)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readxl)
library(optimx)
library(dfoptim)
library(robustlmm)
library(mediation)
library(stringr)
library(ggpubr)
library(gridExtra)
library(lattice)
options(scipen = 50)

```

load data

```{r, message=F, warning=F}
text = read.csv('/Users/roso8920/Emotive Computing Dropbox/Rosy Southwell/EML Rosy/EMLLM/info/ia_label_mapping_opt_surprisal.csv')
eeg_dir = '/Volumes/Blue1TB/EEG_processed/unfolded_FRP_reparsed_v5/n400_stats_recomputed/'
file_pat = '_reading_N400_stats\\.csv$'
files=list.files(path = eeg_dir, pattern= file_pat)
```
Loop over participants
```{r, message=F, warning=F}
all<-c()
i<-0
for (f in files){
    i=i+1
    df <-read.csv(paste0(eeg_dir,f))
    p <- strsplit(f,'_')
    pID <- paste(p[[1]][1],p[[1]][2],sep='_')
    df$pID <- pID
    # df<- df %>% dplyr::select(c("pID", "type","latency","fixDur","task","identifier" , "page_fixation_ix","IA_ID","n400_magnitude_CPz","n400_latency_CPz"  ))
    df<- df %>% filter(task=='reading') %>% droplevels()
    all[[i]] <- df
}
df <- do.call(rbind, all)

# Merge with text info for surprisal values
df <- df %>% merge(text, on=c("IA_ID","identifier"))
df <- df %>% rename(surprisalText=opt.125m_surprisal_wholetext, surprisalPage = opt.125m_surprisal_page,fixDur=duration)
# drop rows with no IA
df <- drop_na(df, "IA_LABEL")
# drop rows with punc
df <- df %>% filter(! IA_LABEL %in% c('.',',','-','--',';',':',"'",'?','!'))

feats <- grep("n400|fixDur",colnames(df), value=T)
feats_eeg <- grep("n400",colnames(df), value=T)

```
# transforms 
```{r}
# df<-df %>% mutate(across(contains('n400_magnitude'),
#              .fns=~log(-.x)), .names="log_neg_{.col}")
df<-df %>% mutate(logFixDur = log(fixDur),
                  logSurprisalText = log(surprisalText),
                  logSurprisalPage = log(surprisalPage))
# lagged surprisal
df <- df %>% group_by(pID, identifier) %>% arrange(page_fixation_ix, .by_group=T) %>% 
  mutate(prev_surprisalText = dplyr::lag(surprisalText, n=1, default=NA),
         prev_surprisalPage = dplyr::lag(surprisalPage, n=1, default=NA))
# refixation
df <- df %>% group_by(pID, identifier, IA_ID) %>% mutate(
  IA_fix_count = n(),
  refixation=as.factor(ifelse(n()>1,1,0)))
```
# plots
```{r, message=F, warning=F}
df_long <- df %>% pivot_longer(all_of(c(feats,'logFixDur')), names_to="feature",values_to="value")
df_long <- df_long %>% mutate(channel=str_match(feature, 'n400_\\w*_([[:alnum:]]{2,5})$')[,2],
                              feature_type=str_match(feature, '(n400_\\w*)_[[:alnum:]]{2,5}$')[,2])
# compute lower and upper whiskers for each group
ylims <- df_long %>%
  group_by(feature_type) %>%
  summarise(Q1 = quantile(value, 1/100), Q3 = quantile(value, 99/100)) %>%
  ungroup()



p1<-ggplot(df_long %>% filter(feature_type=='n400_mean')) + 
  geom_density(aes(x=value, fill=channel), alpha=0.3) + xlim(-1000,1000) + ggtitle('n400_mean')
p2<-ggplot(df_long %>% filter(feature_type=='n400_min_magnitude')) + 
  geom_density(aes(x=value, fill=channel), alpha=0.3) + xlim(-1000,1000) + ggtitle('n400_min')
p3<-ggplot(df_long %>% filter(feature_type=='n400_max_magnitude')) + 
  geom_density(aes(x=value, fill=channel), alpha=0.3) + xlim(-1000,1000) + ggtitle('n400_max')
grid.arrange(p1,p2,p3)


ggplot(df)+
    geom_density(aes(x=fixDur))+
  scale_x_log10()

ggplot(df)+
    geom_density(aes(x=surprisalText))+
  scale_x_log10()


ggplot(df_long)+
    geom_violin(aes(x=value,y=factor(channel), fill=factor(channel),outliers = FALSE), alpha=0.3)+
  facet_wrap(~feature_type, scales="free") 

ggplot(df_long %>% filter(feature_type =='n400_mean'))+
    geom_point(aes(x=surprisalText,y=value, color=factor(channel)), alpha=0.05, size=0.5)+
  facet_wrap(~channel, scales="free") 


```


## repeat some plots after transformatiions
```{r}

ggplot(df,aes(x=logSurprisalText, y=logFixDur)) + 
  geom_point(size=1, alpha=0.05)+stat_cor(method="pearson")
ggplot(df_long %>% filter(feature_type =='n400_mean'))+
    geom_point(aes(x=logSurprisalText,y=value, color=factor(channel)), alpha=0.05, size=0.5)+
  facet_wrap(~channel, scales="free") 
```
# LME stats
## predict EEG from surprisal and fixDur
```{r, message=F, warning=F}
m.m <- lmer(n400_mean_CPz ~ (1|identifier) + (1|pID) + logFixDur + surprisalText, data=df)
m.min <- lmer(n400_max_magnitude_CPz ~ (1|identifier) + (1|pID) + logFixDur + surprisalText, data=df)
m.max <- lmer(n400_min_magnitude_CPz ~ (1|identifier) + (1|pID) + logFixDur + surprisalText, data=df)
m.zc <- lmer(n400_zero_crossings_CPz ~ (1|identifier) + (1|pID) + logFixDur + surprisalText, data=df)
tab_model(m.m, m.min, m.max, m.zc, show.ci=F)

dotplot(ranef(m.m))
```

## predict EEG from LOG surprisal and fixDur
```{r, message=F, warning=F}
m.m <- lmer(n400_mean_CPz ~ (1|identifier) + (1|pID) + logFixDur + logSurprisalText, data=df)
m.min <- lmer(n400_max_magnitude_CPz ~ (1|identifier) + (1|pID) + logFixDur + logSurprisalText, data=df)
m.max <- lmer(n400_min_magnitude_CPz ~ (1|identifier) + (1|pID) + logFixDur + logSurprisalText, data=df)
m.zc <- lmer(n400_zero_crossings_CPz ~ (1|identifier) + (1|pID) + logFixDur + logSurprisalText, data=df)
tab_model(m.m, m.min, m.max, m.zc, show.ci=F)

dotplot(ranef(m.m))
```

## predict fixatoin fixDur from surprisal
```{r, message=F, warning=F}
m.d <- lmer(fixDur ~ (1|identifier) + (1|pID) + surprisalText, data=df)
tab_model(m.d)
```

## predict fixation fixDur from EEG features
```{r, message=F, warning=F}
m.eye <- lmer(fixDur ~ (1|identifier) + (1|pID) + n400_mean_CPz, data=df)
tab_model(m.eye)
```

## predict EEG and surprisal from previous IA surprisal
```{r, message=F, warning=F}
mp.m <- lmer(n400_mean_CPz ~ (1|identifier) + (1|pID) + logFixDur + surprisalText + prev_surprisalText, data=df)
tab_model(mp.m)
mp.s <- lmer( surprisalText ~ (1|identifier) + (1|pID) + prev_surprisalText, data=df)
tab_model(mp.s)
```
## model including bool for refixation 
```{r, message=F, warning=F}
mr.m <- lmer(n400_mean_CPz ~ (1|identifier) + (1|pID) + logFixDur + refixation*surprisalText, data=df)
tab_model(mr.m)
Anova(mr.m)
plot_model(mr.m,type = "emm", terms=c("surprisalText", "refixation"))

```
## predict EEG from surprisal and fixDur with random slope of surprisal for participant
```{r, message=F, warning=F}
m.rs.m <- lmer(n400_mean_CPz ~ (1+surprisalText|pID)  + surprisalText, data=df)
tab_model(m.rs.m, show.ci=F)

dotplot(ranef(m.rs.m))
```

# Behavioural data
```{r, message=F, warning=F}

df_comp <- read.csv('/Users/roso8920/Emotive Computing Dropbox/Rosy Southwell/EyeMindLink/Processed/Behaviour/EML1_page_level.csv')
df_comp <- df_comp %>% rename(pID=ParticipantID) %>% 
  mutate(Page=PageNum-1,
         identifier=paste0(Text, Page))
df <- merge(df, df_comp, on=c("pID","identifier"))
df_mw <- df %>% drop_na(MW)
```

## model N400 ~ surprisal*MW
```{r, message=F, warning=F}
m.mw <- lmer(n400_mean_CPz ~ (1+surprisalText|pID)  + surprisalText*MW, data=df_mw)
Anova(m.mw)
tab_model(m.mw)
plot_model(m.mw,type = "emm", terms=c("surprisalText", "MW"))
emmeans(m.mw, pairwise ~ MW, p.adjust = "fdr")

```


## model MW ~ surprisal*N400
```{r, message=F, warning=F}

m.mw.2 <- glmer(MW ~ surprisalText * n400_mean_CPz + (1|identifier) + (1|pID), data=df_mw, family = "binomial")
tab_model(m.mw.2)
```

# Eye-mind-linkage metric at page level
```{r, message=F, warning=F, fig.width=3, fig.height=3}
eml_page <- df %>% group_by(pID, identifier) %>% summarise(
  cor_n400meanCPz_surprisalText = cor(surprisalText, n400_mean_CPz),
  cor_logFixDur_surprisalText = cor(surprisalText, logFixDur),
    cor_n400meanCPz_surprisalPage = cor(surprisalPage, n400_mean_CPz),
  cor_logFixDur_surprisalPage = cor(surprisalPage, logFixDur),
    R_n400meanCPz_surprisalText = cor(surprisalText, n400_mean_CPz)^2,
  R_logFixDur_surprisalText = cor(surprisalText, logFixDur)^2,
      R_n400meanCPz_surprisalPage = cor(surprisalPage, n400_mean_CPz)^2,
  R_logFixDur_surprisalPage = cor(surprisalPage, logFixDur)^2,
  # log scaled surprisal
    cor_n400meanCPz_logSurprisalText = cor(logSurprisalText, n400_mean_CPz),
  cor_logFixDur_logSurprisalText = cor(logSurprisalText, logFixDur),
    cor_n400meanCPz_logSurprisalPage = cor(logSurprisalPage, n400_mean_CPz),
  cor_logFixDur_logSurprisalPage = cor(logSurprisalPage, logFixDur),
    R_n400meanCPz_logSurprisalText = cor(logSurprisalText, n400_mean_CPz)^2,
  R_logFixDur_logSurprisalText = cor(logSurprisalText, logFixDur)^2,
      R_n400meanCPz_logSurprisalPage = cor(logSurprisalPage, n400_mean_CPz)^2,
  R_logFixDur_logSurprisalPage = cor(logSurprisalPage, logFixDur)^2,
)
df_page <- merge(df_comp, eml_page, on=c('pID', 'identifer'))
df_page$MW = as.factor(df_page$MW)


# plot the new metrics
p1<-ggplot(df_page %>% drop_na(MW))+
  geom_density( aes(x=cor_n400meanCPz_surprisalText, color=MW))
p2<-ggplot(df_page %>% drop_na(MW))+
  geom_density( aes(x=R_n400meanCPz_surprisalText, color=MW))
grid.arrange(p1,p2, nrow=1)
# plot by participantID
ggplot(df_page, aes(x=cor_n400meanCPz_surprisalText, y=pID)) +
  geom_boxplot(  horizontal = TRUE,        outlier.colour="red",
        outlier.fill="red",
        outlier.size=0.2)

```

## binomial regression: predict page level MW from page level correlations with surprisal
```{r, message=F, warning=F}

m.mwt <- glmer(MW ~ cor_n400meanCPz_logSurprisalText  + cor_logFixDur_logSurprisalText + (1|identifier) + (1|pID), data=df_page %>% drop_na(MW), family = "binomial")
tab_model(m.mwt)
Anova(m.mwt)
plot_model(m.mwt,type = "emm", terms=c("cor_n400meanCPz_logSurprisalText"))
```
### from Rsquared rather than correlation
```{r, message=F, warning=F}

m.mwR <- glmer(MW ~ R_n400meanCPz_surprisalText  + R_logFixDur_surprisalText + (1|identifier) + (1|pID), data=df_page %>% drop_na(MW), family = "binomial")
tab_model(m.mwR)
```